<html><head lang="ja"><link rel="icon" type="image/png" href="favicon.png"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><meta property="og:type" content="article"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image:width" content="1200"/><meta name="twitter:image:height" content="630"/><meta name="author" content="Hinase"/><meta name="keywords" content="Deep Learning, Neural Network, TensorFlow, Machine Learning, CUDA, nVidia"/><meta property="og:title" content="GPU用TensorFlowのソースビルド。インストール"/><meta property="og:description" content="CUDAが有効なNVidia製グラフィックカードを使ってTensorFlowを高速化。ソースインストールの手順を説明します。"/><meta property="og:url" content="https://hinaser.github.io/Machine-Learning/deeplearning-by-tensorflow-with-gpu.html"/><meta property="og:image" content="https://hinaser.github.io/Machine-Learning/preview.png"/><meta name="twitter:title" content="GPU用TensorFlowのソースビルド。インストール"/><meta name="twitter:description" content="CUDAが有効なNVidia製グラフィックカードを使ってTensorFlowを高速化。ソースインストールの手順を説明します。"/><meta name="twitter:url" content="https://hinaser.github.io/Machine-Learning/deeplearning-by-tensorflow-with-gpu.html"/><meta name="twitter:image" content="https://hinaser.github.io/Machine-Learning/preview.png"/><title>GPU用TensorFlowのソースビルド・インストール</title><link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/><link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css"/><script defer="" src="https://code.getmdl.io/1.3.0/material.min.js"></script><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/><link href="https://fonts.googleapis.com/earlyaccess/notosansjapanese.css" rel="stylesheet"/><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link rel="stylesheet" href="css/lib.css" type="text/css" data-turbolinks-track="reload"/><link rel="stylesheet" href="css/main.css?e373429ef6" type="text/css" data-turbolinks-track="reload"/><script id="st_insights_js" type="text/javascript" src="https://ws.sharethis.com/button/buttons.js?publisher=8fde68e6-f234-4808-b7ab-c498ac41fe48"></script><script type="text/javascript">stLight.options({
    publisher: "8fde68e6-f234-4808-b7ab-c498ac41fe48",
    doNotHash: true,
    doNotCopy: true,
    hashAddressBar: false
});</script><script src="js/lib.js?6099111fed" data-turbolinks-track="reload"></script></head><body><div class="dpln-layout top-header-left-nav-layout fixed-top"><header class="dpln-layout-header"><i class="material-icons" id="toggle-nav">view_headline</i><span class="site-title">機械学習、ディープラーニング</span></header><nav class="dpln-layout-nav"><figure class="collapsible" data-page="learntensorflowplayground"><figcaption><span class="menu-title">TensorFlow Playgroundの仕組み</span><button class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">keyboard_arrow_down</i></button></figcaption><ul><li><a href="index.html#preface-part">はじめに</a></li><li><a href="index.html#reference-part">参考文献</a></li><li><a href="index.html#summary-part">Playgroundの仕組み</a></li><li><a href="index.html#learningsettings-part">ニューラルネットワークについて</a></li><li><a href="index.html#about-learning-in-nn-part">ニューラルネットワークの学習に関する設定</a></li><li><a href="index.html#learningrate-part">学習率</a></li><li><a href="index.html#activator-part">活性化関数</a></li><li><a href="index.html#regularization-part">正則化、正則化項</a></li><li><a href="index.html#problemtype-part">統計モデルの種類</a></li><li><a href="index.html#inputdata-part">データに関する設定</a></li><li><a href="index.html#dataselection-part">どのデータセットを使うか</a></li><li><a href="index.html#ratio-of-training-data-part">トレーニングデータの割合</a></li><li><a href="index.html#noise-part">ノイズ</a></li><li><a href="index.html#batchsize-part">バッチサイズ</a></li><li><a href="index.html#feature-part">入力するデータの特徴と隠し層</a></li><li><a href="index.html#backpropagation-part">バックプロパゲーション(誤差逆伝搬法)</a></li></ul></figure><figure class="collapsible" data-page="[&quot;deeplearning-by-tensorflow&quot;, &quot;how-to-use-tensorboard&quot;]"><figcaption><span class="menu-title">TensorFlowでディープラーニング</span><button class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">keyboard_arrow_down</i></button></figcaption><div class="dpln-expand"></div><ul><li><a href="deeplearning-by-tensorflow.html">TensorFlowのインストール</a></li><li><a href="deeplearning-by-tensorflow-with-gpu.html">TensorFlowのインストール(GPU利用編)</a></li><li><a href="how-to-use-tensorboard.html">TensorBoardの使い方</a></li><li><a href="tensorflow-faq.html">TensorFlow FAQ</a></li></ul></figure><figure class="collapsible" data-page="[&quot;tensorflow-code-samples&quot;]"><figcaption><span class="menu-title">TensorFlow コードサンプル</span><button class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">keyboard_arrow_down</i></button></figcaption><ul><li><a href="tensorflow-code-samples.html">インデックス</a></li></ul></figure><figure class="collapsible" data-page="math-for-ml"><figcaption><span class="menu-title">機械学習のための数学</span><button class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">keyboard_arrow_down</i></button></figcaption><ul><li><a href="math-for-ml.html">はじめに</a></li><li><a href="math-for-ml.html#random-variable">確率変数</a></li><li><a href="math-for-ml.html#probability-distribution">確率分布</a></li><li><a href="math-for-ml.html#pmf">離散確率分布</a></li><li><a href="math-for-ml.html#pdf">連続確率分布</a></li><li><a href="math-for-ml.html#expectation">期待値</a></li><li><a href="math-for-ml.html#self-information">自己情報量</a></li><li><a href="math-for-ml.html#entropy">エントロピー</a></li><li><a href="math-for-ml.html#kl-divergence">KL情報量</a></li><li><a href="math-for-ml.html#cross-entropy">クロスエントロピー</a></li><li><a href="math-for-ml.html#logits">ロジット</a></li><li><a href="math-for-ml.html#softmax">ソフトマックス関数</a></li><li><a href="math-for-ml.html#sigmoid">シグモイド関数</a></li><li><a href="math-for-ml.html#multiclass-classification">多クラス分類</a></li><li><a href="math-for-ml.html#multilabel-classification">マルチラベル分類</a></li></ul></figure><figure class="collapsible" data-page="[&quot;profile&quot;, &quot;reference&quot;, &quot;useful-tools-and-services&quot;, &quot;private-thoughts&quot;]"><figcaption><span class="menu-title">その他</span><button class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">keyboard_arrow_down</i></button></figcaption><ul><li><a href="profile.html">著者プロフィール</a></li><li><a href="reference.html">参考サイト集</a></li><li><a href="useful-tools-and-services.html">お世話になっているツール/サービス</a></li><li><a href="private-thoughts.html">独り言</a></li></ul></figure></nav><main class="dpln-layout-main"><article class="main-article" data-page="deeplearning-by-tensorflow"><a class="in-page-anchor" id="preface-part"></a><h1>TensorFlowのインストール(GPU利用編)</h1><div class="article-metadata"><div id="post-date"><i class="material-icons md-24">timer</i><span>2017-03-06</span></div><div id="author"><i class="material-icons md-24">person</i><span>Hinase</span></div><span class="author-external-profile"><a class="header-logo-invertocat" href="https://github.com/Hinaser" aria-label="Github Profile"><svg class="octicon octicon-mark-github" aria-hidden="true" height="24" version="1.1" viewbox="0 0 16 16" width="24" fill="rgba(0, 0, 0, 0.7)"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg></a><a class="header-logo-twitter" href="https://twitter.com/h1nase" target="_blank" style="line-height: 30px; display: inline-block; vertical-align: middle; margin-left: 10px; margin-right: 10px;"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 400 400" height="24"><defs><style>.cls-1 {
  fill: #1da1f2;
}

.cls-2 {
  fill: #fff;
}

.cls-3 {
  fill: none;
}</style></defs><title>Twitter_Logo_White-on-Blue</title><g id="Dark_Blue" data-name="Dark Blue"><rect class="cls-1" width="400" height="400"></rect></g><g id="Logo_FIXED" data-name="Logo — FIXED"><path class="cls-2" d="M153.62 301.59c94.34 0 145.94-78.16 145.94-145.94 0-2.22 0-4.43-.15-6.63A104.36 104.36 0 0 0 325 122.47a102.38 102.38 0 0 1-29.46 8.07 51.47 51.47 0 0 0 22.55-28.37 102.79 102.79 0 0 1-32.57 12.45 51.34 51.34 0 0 0-87.41 46.78A145.62 145.62 0 0 1 92.4 107.81a51.33 51.33 0 0 0 15.88 68.47A50.91 50.91 0 0 1 85 169.86c0 .21 0 .43 0 .65a51.31 51.31 0 0 0 41.15 50.28 51.21 51.21 0 0 1-23.16.88 51.35 51.35 0 0 0 47.92 35.62 102.92 102.92 0 0 1-63.7 22A104.41 104.41 0 0 1 75 278.55a145.21 145.21 0 0 0 78.62 23"></path><rect class="cls-3" width="400" height="400"></rect></g></svg></a></span><span class="social-share"><span class="st_facebook_hcount" displaytext="Facebook"></span><span class="st_twitter_hcount" displaytext="Tweet"></span><span class="st_googleplus_hcount" displaytext="Google +"></span></span></div><div class="paragraph"><a class="in-page-anchor" id="install-tensorflow"></a><p class="warning-this-is-not-extra-content">このページはCUDAに対応したNVidia製グラフィックカードを持っている人向けの内容です。</p><p>このページではGPU計算を有効にしたTensorFlowをインストールする手順を紹介します。
GPUは並列化処理に優れておりTensorFlowでの数値計算速度を向上させることができます。</p><p>TensorFlowはCUDAと呼ばれる、NVidia社が開発した並列計算プラットフォームを利用して高速化させることができます。<a href="http://www.cs.nyu.edu/manycores/cuda_many_cores.pdf" target="_blank">CUDAについてはこちらを参考にしてください。</a></p><h4>GPU版TensorFlowが利用できるNVidia GeForce GPU</h4><p>2017年3月6日現在、<a href="https://www.tensorflow.org/install/install_sources#optional_install_tensorflow_for_gpu_prerequisites" target="_blank">TensorFlowのインストールページ</a>ではCuda Compute Capability3.0以上のグラフィックカードが必要と記載されていいます。
CUDA 3.0以上対応GeForceグラフィックカードは下記のとおりです。
参考:<a href="https://developer.nvidia.com/cuda-gpus" target="_blank">CUDA GPUs</a><br/>ざっと見たところ、6XX系以上のGeForceグラフィックカードを持っていれば大丈夫のようです。</p><h6>デスクトップ版GeForce</h6><table class="list-of-tensorflow-enabled-gpus"><tr><td>GTX 10XX系</td><td>1080Ti, 1080, 1070, 1060, 1050</td></tr><tr><td>TITAN系</td><td>NVIDIA TITAN X, GTX TITAN X, GTX TITAN Z, GTX TITAN Black</td></tr><tr><td>GTX 9XX系</td><td>980Ti, 980, 970, 960, 950</td></tr><tr><td>GTX 7XX系</td><td>780Ti, 780, 770, 760, 750Ti, 750</td></tr><tr><td>GT 7XX系</td><td>GT740, GT730(*), GT720, GT705</td></tr><tr><td>GTX 6XX系</td><td>690, 680, 670, 660Ti, 660, 650Ti BOOST, 650Ti, 650</td></tr><tr><td>GT 6XX系</td><td>GT640[GDDR5版]</td></tr></table><small>(*) GT730 DDR3, 128bit版を除く</small><h6>ノートブック版GeForce</h6><table class="list-of-tensorflow-enabled-gpus"><tr><td>10XX系</td><td>1080, 1070, 1060</td></tr><tr><td>9XX系</td><td>980, 980M, 970M, 965M, 960M, 950M, 940M, 930M, 920M, 910M</td></tr><tr><td>8XX系</td><td>880M, 870M, 860M, 850M, 840M, 830M</td></tr><tr><td>7XX系</td><td>780M, 770M, 765M, 760M, 750M, 745M, 740M, 735M, 730M</td></tr><tr><td>GTX 6XX系</td><td>680MX, 680M, 675MX, 670MX, 660M, 650M, 645M, 640M, 640M LE</td></tr></table><h4>インストール環境</h4><p>手順を作成するにあたって用意したマシン環境です。</p><table class="install-environment"><tr><td>GPU</td><td>NVidia GeForce GTX 780</td><td>ASUS GTX780-DC2OC-3GD5</td></tr><tr><td>OS</td><td>Ubuntu 16.04 64bit</td><td><a href="https://www.ubuntu.com/download/desktop" target="_blank">Ubuntu Desktop</a></td></tr><tr><td>Python</td><td>3.5.2</td><td><code>sudo apt-get install python3</code></td></tr><tr><td>TensorFlow</td><td>r1.0</td><td><a href="https://github.com/tensorflow/tensorflow/tree/r1.0" target="_blank">https://github.com/tensorflow/tensorflow/tree/r1.0</a></td></tr></table><h4>インストール手順</h4><p>Ubuntu 16.04/Python3.5/GPUサポート有り/GTX780/ソースインストール/virtualenv利用 の構成でのインストール手順を紹介します。<br/>ちなみにこの手順は2017/3/7に検証した手順であり、将来同じ手順で正しくTensorFlowをインストールできない可能性があります。</p><h5>1. CUDA Tookitのインストール</h5><p>参考:<a href="http://docs.nvidia.com/cuda/cuda-installation-guide-linux/#axzz4VZnqTJ2A" target="_blank">NVIDIA CUDA Installation Guide For Linux</a></p><p>CUDAが利用できるGPUが認識されているか確認</p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">lspci | grep -i nvidia</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>ここで何も表示されない場合、NVIDIA製のグラフィックボードがインストールされていない、もしくは認識されていないため
これ以降の手順は実施できません。</p><p>gccがインストールされていることを確認します。</p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">gcc --version</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>gcc 5.3.1以降がインストールされていればOK</p><p>Linuxカーネルヘッダーをインストールします。</p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">sudo apt-get install linux-headers-$(uname -r)</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>Ubuntu 16.04用のCUDA Tookitをインストールします。<br/>まず、<a href="https://developer.nvidia.com/cuda-downloads" target="_blank">CUDAダウンロードページ</a>からUbuntu用debファイルをダウンロードします。<br/><img class="download-cuda-toolkit" src="image/deeplearning-by-tensorflow/download-cuda-toolkit.png"/><br/>ダウンロードした.debファイルは/tmpに移動しておきます。</p><p>cuda toolkitをインストールします。(インストールサイズが2GBほどあるので注意。ネットワークが遅いと数十分から数時間かかります。)</p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">sudo dpkg -i /tmp/cuda-repo-ubuntu1604_8.0.61-1_amd64.deb</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">$&nbsp;<span class="user-input">sudo apt-get update</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">$&nbsp;<span class="user-input">sudo apt-get install cuda</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>環境変数LD_LIBRARY_PATHを設定します。</p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">export LD_LIBRARY_PATH=/usr/local/cuda-8.0/extras/CUPTI/lib64:/usr/local/cuda-8.0/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">$&nbsp;<span class="user-input">echo &quot;export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}&quot; &gt;&gt; ~/.profile</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><h5>2. cuDNNのインストール</h5><p>参考:<a href="https://developer.nvidia.com/cudnn" target="_blank">NVIDIA cuDNN</a></p><p>cuDNNはディープラーニング研究者・開発者用のライブラリであり、ダウンロードするにはnVidiaのAccelerated Computing Developer Programのメンバーになる必要があります。
メンバー登録自体は簡単で、nVidiaのサイトでアカウントを作成するだけです。</p><p><a href="https://developer.nvidia.com/cudnn" target="_blank">nVidiaのcuDNNダウンロードサイト</a>に行きDownloadボタンをクリックします。<a href="https://developer.nvidia.com/cudnn" target="_blank"><img src="image/deeplearning-by-tensorflow/download-cuDNN.png" alt=""/></a></p><p>Join Nowボタンをクリックします。<br/><img src="image/deeplearning-by-tensorflow/cnDNN-membership-required.png" alt=""/></p><p>Eメールアドレス、氏名、組織名、国、規約に同意ボタンをチェックし、Nextボタンをクリックします。<br/>組織ではなく個人で登録する場合は組織名(Organization)の箇所は適当にIndividual Developerとでもしておけば良いです。<br/><img src="image/deeplearning-by-tensorflow/cuDNN-fill-basic-information.png"/></p><p>次のページに行くとアンケート形式でいくつか質問をされます。</p><p>登録完了後再度上のDownloadボタンを押すことでcuDNNをダウンロードすることができます。<br/>インストール方法はメンバー登録後cuDNNのダウンロードページにあるインストールガイドに記載されているのでそちらを参考にしてください。
私の環境ではダウンロードしたcuDNNのアーカイブ内のlib64/, include/ディレクトリをそのままCUDA Toolkitの$LD_LIBRARY_PATHに上書き展開しています。</p><h5>3. libcupti-devのインストール</h5><div class="code"><div class="code-line">$&nbsp;<span class="user-input">sudo apt-get install libcupti-dev</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><h5>4. Bazelのインストール</h5><p>参考URL:<a href="https://bazel.build/versions/master/docs/install.html" target="_blank">https://bazel.build/versions/master/docs/install.html</a></p><p>BazelはGoogle製のビルドツールです。TensorFlowをソースからビルドする際に必要になります。<br/>bazelがJDK1.9に対応していないため、JDK1.9がOSにインストールされていると上記手順途中でエラーが発生します。
私は下記のようにしてJava9/JDK1.9をアンインストールしました。<br/><small>* 利用している他のソフトウェアがJava1.9を利用している場合はそのソフトウェアが動作しなくなる可能性があります。
コマンドの意味や影響がわからなければ実行しないでください。</small></p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">sudo apt-get purge openjdk-9* java-9*</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>次にJDK1.8をインストールします。</p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">sudo apt-get install openjdk-8-j*</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">$&nbsp;<span class="user-input">java -version</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line no-copy">&nbsp;&nbsp;# openjdk version "1.8.x_xxx" と表示されることを確認。</div></div><p>Bazelの配布用URIとパッケージソースの追加</p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">echo &quot;deb [arch=amd64] http://storage.googleapis.com/bazel-apt stable jdk1.8&quot; | sudo tee /etc/apt/sources.list.d/bazel.list</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">$&nbsp;<span class="user-input">curl https://bazel.build/bazel-release.pub.gpg | sudo apt-key add -</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>Bazelのインストール</p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">sudo apt-get update &amp;&amp; sudo apt-get install bazel</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><h5>5. PythonのVirtualenv環境のセットアップ</h5><p>TensorFlow専用のPython実行環境を作成します。Virtualenvを使うとプロジェクト専用のPythonバージョン、Pythonソフトウェアパッケージ
を構築できるようになります。Virtualenv環境を切り替えるとPythonのバージョンや利用できるパッケージも自由に切り替えられるようになります。</p><p>pip3をインストールします。</p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">sudo apt-get install python3-pip</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>virtualenvをインストールします。</p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">sudo apt-get install python-virtualenv</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>TensorFlow用のvirtualenv環境を作成し、環境を有効にします。下記のコマンドを実行すると/home/&lt;ユーザ名&gt; ディレクトリ直下に
新たにtensorflowというディレクトリを作成します。</p><div class="code"><div class="code-line">$&nbsp;<span class="user-input">virtualenv -p python3 --system-site-packages ~/tensorflow</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">$&nbsp;<span class="user-input">source ~/tensorflow/bin/activate</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>環境が有効になっていればプロンプトが下記のように変化しているはずです。</p><div class="code"><div class="code-line no-copy">(tensorflow)$</div></div><p>この状態でpip installを実行すると、このvirtualenv環境にのみpipパッケージがインストールされます。</p><div class="indent"><p>※ちなみに環境を抜けたい場合は下記を実行すればOKです。</p><div class="code"><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">deactivate</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div></div><p>次にTensorFlowで必要なパッケージをvirtualenv環境にインストールします。</p><div class="code"><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">pip install six numpy wheel</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><h5>6. TensorFlowのソースをダウンロード/ビルド構成を設定する。</h5><p>まずはGithubのTensorFlowのレポジトリからソースコードをダウンロードします。</p><div class="code"><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">mkdir -p ~/projects</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">cd ~/projects</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">git clone https://github.com/tensorflow/tensorflow</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">cd tensorflow</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">git checkout r1.0</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>ソースのビルド構成を設定します。下記を参考にCUDAに関係しない設定はそのままEnterでデフォルトの設定を使うようにします。</p><div class="code"><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">./configure</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line no-copy">Please specify the location of python. [Default is /home/ユーザ名/tensorflow/bin/python]:</div>Please specify optimization flags to use during compilation [Default is -march=native]:<div class="code-line no-copy">Do you wish to use jemalloc as the malloc implementation? (Linux only) [Y/n]</div><div class="code-line no-copy">Do you wish to build TensorFlow with Google Cloud Platform support? [y/N]</div><div class="code-line no-copy">Do you wish to build TensorFlow with Hadoop File System support? [y/N]</div><div class="code-line no-copy">Do you wish to build TensorFlow with the XLA just-in-time compiler (experimental)? [y/N]</div><div class="code-line no-copy">Please input the desired Python library path to use.  Default is [/home/ユーザ名/tensorflow/lib/python3.5/site-packages]</div><div class="code-line no-copy">Do you wish to build TensorFlow with OpenCL support? [y/N]</div><div class="code-line">Do you wish to build TensorFlow with CUDA support? [y/N]&nbsp;&nbsp;<span class="user-input">Y</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line no-copy">CUDA support will be enabled for TensorFlow</div><div class="code-line no-copy">Please specify which gcc should be used by nvcc as the host compiler. [Default is /usr/bin/gcc]:</div><div class="code-line">Please specify the Cuda SDK version you want to use, e.g. 7.0. [Leave empty to use system default]:&nbsp;&nbsp;<span class="user-input">8.0</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line no-copy">Please specify the location where CUDA 8.0 toolkit is installed. Refer to README.md for more details. [Default is /usr/local/cuda]:</div><div class="code-line">Please specify the cuDNN version you want to use. [Leave empty to use system default]:&nbsp;&nbsp;<span class="user-input">5</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line no-copy">Please specify the location where cuDNN 5 library is installed. Refer to README.md for more details. [Default is /usr/local/cuda]:</div><div class="code-line no-copy">Please specify a list of comma-separated Cuda compute capabilities you want to build with.</div><div class="code-line no-copy">You can find the compute capability of your device at: https://developer.nvidia.com/cuda-gpus.</div><div class="code-line no-copy">Please note that each additional compute capability significantly increases your build time and binary size.</div><div class="code-line">[Default is: "3.5,5.2"]: &nbsp;&nbsp;<span class="user-input">3.5</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><div class="indent"><p>ちなみに私の環境ではここで下記のようなエラーが出力されてしまいました。</p><code>ERROR: /home/ユーザ名/projects/tensorflow/tensorflow/python/BUILD:2275:1: every rule of type _py_wrap_cc implicitly depends upon the target '@swig//:templates', but this target could not be found because of: no such package '@swig//': Error downloading [http://bazel-mirror.storage.googleapis.com/ufpr.dl.sourceforge.net/project/swig/swig/swig-3.0.8/swig-3.0.8.tar.gz, http://ufpr.dl.sourceforge.net/project/swig/swig/swig-3.0.8/swig-3.0.8.tar.gz, http://pilotfiber.dl.sourceforge.net/project/swig/swig/swig-3.0.8/swig-3.0.8.tar.gz] to /home/ユーザ名/.cache/bazel/_bazel_ユーザ名/3f6df72b6e217920e9a8b0ddfd37c24d/external/swig/swig-3.0.8.tar.gz: All mirrors are down: [].
ERROR: Evaluation of query "deps((//tensorflow/... - //tensorflow/examples/android/...))" failed: errors were encountered while computing transitive closure.</code><p>私が確認した限りでは、tensorflowの外部依存パッケージ'swig'のダウンロードタイムアウトが原因のエラーのようです。<br/>curlコマンドで上記エラー内の"bazel-mirror.storage.googleapis.com"と"pilotfiber.dl.sourceforge.net"および"pilotfiber.dl.sourceforge.net"
に対してswig-3.0.8.tar.gzのダウンロードを試してみたところ、"bazel-mirror.storage.googleapis.com"以外の2つのミラーサイトの反応が遅いことがわかりました。
(数秒待てばダウンロード自体は始まります)。
おそらくbazelはパッケージのダウンロードに対するレスポンスタイムアウトの閾値が厳しく設定されており、
パッケージの配信サーバがもたつくとサーバがダウンしていると判断してしまうようです。</p><p>この問題を解決するため、 tensorflow/tensorflow/workspace.bzl ファイルを下記のように修正し、
レスポンスが遅い２つのサーバをダウンロードリストから外して再度<code class="code">./configure</code>コマンドを実行したところ、無事エラーなくコマンドが完了しました。</p><div class="code file-edit">native.new_http_archive(
&nbsp;&nbsp;&nbsp;&nbsp;name = "swig",
&nbsp;&nbsp;&nbsp;&nbsp;sha256 = "58a475dbbd4a4d7075e5fe86d4e54c9edde39847cdb96a3053d87cb64a23a453",
&nbsp;&nbsp;&nbsp;&nbsp;urls = [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"http://bazel-mirror.storage.googleapis.com/ufpr.dl.sourceforge.net/project/swig/swig/swig-3.0.8/swig-3.0.8.tar.gz",<br/><span class="strike-through">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"http://ufpr.dl.sourceforge.net/project/swig/swig/swig-3.0.8/swig-3.0.8.tar.gz",</span>&nbsp;←この行を削除<br/><span class="strike-through">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"http://pilotfiber.dl.sourceforge.net/project/swig/swig/swig-3.0.8/swig-3.0.8.tar.gz",</span>&nbsp;←この行を削除<br/>&nbsp;&nbsp;&nbsp;&nbsp;],
&nbsp;&nbsp;&nbsp;&nbsp;strip_prefix = "swig-3.0.8",
&nbsp;&nbsp;&nbsp;&nbsp;build_file = str(Label("//third_party:swig.BUILD")),
)</div><p>同じようなエラーが発生した方は上記の方法を試してみてください。<code class="code">./configure</code>コマンドの実行が完了したあとは、ソースコードを<code class="code">git reset --hard</code>で戻しておきましょう。</p></div><h5>7. TensorFlowのソースをビルドする。</h5><p>bazel buildでソースをビルドします。<br/>ちなみに私のマシン(CPU: i7-2600K@3.9GHz, 4C8T, RAM: 16GB)では23分かかりました。
CPU使用率もほとんどの時間で8コアとも使用率100%、メモリも見ていた限り最大で11GBほど使用していました。
他の作業と同時並行でビルドするのはやめたほうが良いです。他のアプリを閉じたうえでビルドしましょう。</p><div class="code"><div class="code-line">(tensorflow)$<span class="user-input">bazel build -c opt --copt=-mavx --copt=-mavx2 --copt=-mfma --copt=-mfpmath=both --copt=-msse4.2 --config=cuda //tensorflow/tools/pip_package:build_pip_package</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>上記のコマンドが完了すると、bazel-bin/tensorflow/tools/pip_package/build_pip_packageというファイルが作成されます。
そのファイル名の通り、TensorFlowのpipパッケージを作成するツールです。</p><div class="indent"><p>※上記のコマンドはAVX/AVX2/FMA/SSE4.2の拡張命令セットが使えるCPUでのみ有効です。(ビルドは成功しますがプログラム実行時にエラーが発生します。)<br/>私の持っているCPU(Intel Core i7 2600K)ではAVX2とFMAはサポートされてなかったため、AVX2/FMAに関するオプションを削除した上で実行しました。</p><div class="code"><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">bazel build -c opt --copt=-mavx --copt=-mfpmath=both --copt=-msse4.2 --config=cuda //tensorflow/tools/pip_package:build_pip_package</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div></div><h5>8. TensorFlowのpipパッケージを作成し、インストールする。</h5><p>カスタムビルドしたTensorFlowをpipパッケージ化します。
下記のコマンドを実行すると、/tmp/tensorflow_pkgディレクトリ直下にpipパッケージファイル(~.whl)を生成します。
このコマンドは先程までとは違い、20秒ほどで完了します。</p><div class="code"><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">bazel-bin/tensorflow/tools/pip_package/build_pip_package /tmp/tensorflow_pkg</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div></div><p>生成された.whlファイルでpipインストールします。</p><div class="code"><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">pip install $(ls /tmp/tensorflow_pkg/*.whl)</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line no-copy">...</div><div class="code-line no-copy">Successfully installed protobuf-3.2.0 tensorflow-1.0.0</div></div><p>これでTensorFlowのソースインストールは完了です。</p><h5>9. インストールの検証</h5><p>TensorFlowが正しくインストールされたか確認します。</p><div class="code"><div class="code-line no-copy"># tensorflowのプロジェクトディレクトリにいるままだとエラーがでるのでディレクトリを出ます。</div><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">cd ../</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">(tensorflow)$&nbsp;<span class="user-input">python</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">>>>&nbsp;<span class="user-input">import tensorflow as tf</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">>>>&nbsp;<span class="user-input">hello = tf.constant('Hello world')</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">>>>&nbsp;<span class="user-input">sess = tf.Session()</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line">>>>&nbsp;<span class="user-input">print(sess.run(hello))</span><div class="clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></div></div><div class="code-line no-copy"># b'Hello world' と表示されればOKです。</div></div></div><div id="disqus_thread"></div><script>var disqus_config = function () {
    this.page.url = document.location.href;
    this.page.identifier = document.location.pathname;
};
(function () { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://hinaser-github-io-machine-learning.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script></article></main></div><script src="js/main.js?8fc1038fbd" data-turbolinks-track="reload"></script><script src="js/raw/analytics.js" data-turbolinks-track="reload"></script></body></html>