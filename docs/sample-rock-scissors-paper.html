<html><head lang="ja"><link rel="icon" type="image/png" href="favicon.png"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><meta property="og:type" content="article"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image:width" content="1200"/><meta name="twitter:image:height" content="630"/><meta name="author" content="Hinase"/><meta name="keywords" content="TensorFlow, Machine Learning, Math, Python, Source code, Samples"/><meta property="og:title" content="TensorFlow コードサンプル"/><meta property="og:description" content="TensorFlowのPythonコードサンプルを公開します。"/><meta property="og:url" content="https://hinaser.github.io/Machine-Learning/tensorflow-code-samples.html"/><meta property="og:image" content="https://hinaser.github.io/Machine-Learning/preview.png"/><meta name="twitter:title" content="TensorFlow コードサンプル"/><meta name="twitter:description" content="TensorFlowのPythonコードサンプルを公開します。"/><meta name="twitter:url" content="https://hinaser.github.io/Machine-Learning/tensorflow-code-samples.html"/><meta name="twitter:image" content="https://hinaser.github.io/Machine-Learning/preview.png"/><title>TensorFlow コードサンプル</title><link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/><link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css"/><script defer="" src="https://code.getmdl.io/1.3.0/material.min.js"></script><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/><link href="https://fonts.googleapis.com/earlyaccess/notosansjapanese.css" rel="stylesheet"/><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link rel="stylesheet" href="css/lib.css" type="text/css" data-turbolinks-track="reload"/><link rel="stylesheet" href="css/main.css?0e3c0ca367" type="text/css" data-turbolinks-track="reload"/><script id="st_insights_js" type="text/javascript" src="https://ws.sharethis.com/button/buttons.js?publisher=8fde68e6-f234-4808-b7ab-c498ac41fe48"></script><script type="text/javascript">stLight.options({
    publisher: "8fde68e6-f234-4808-b7ab-c498ac41fe48",
    doNotHash: true,
    doNotCopy: true,
    hashAddressBar: false
});</script><script src="js/lib.js?6099111fed" data-turbolinks-track="reload"></script></head><body><div class="dpln-layout top-header-left-nav-layout fixed-top"><header class="dpln-layout-header"><i class="material-icons" id="toggle-nav">view_headline</i><span class="site-title">機械学習、ディープラーニング</span></header><nav class="dpln-layout-nav"><figure class="collapsible" data-page="learntensorflowplayground"><figcaption><span class="menu-title">TensorFlow Playgroundの仕組み</span><button class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">keyboard_arrow_down</i></button></figcaption><ul><li><a href="index.html#preface-part">はじめに</a></li><li><a href="index.html#reference-part">参考文献</a></li><li><a href="index.html#summary-part">Playgroundの仕組み</a></li><li><a href="index.html#learningsettings-part">ニューラルネットワークについて</a></li><li><a href="index.html#about-learning-in-nn-part">ニューラルネットワークの学習に関する設定</a></li><li><a href="index.html#learningrate-part">学習率</a></li><li><a href="index.html#activator-part">活性化関数</a></li><li><a href="index.html#regularization-part">正則化、正則化項</a></li><li><a href="index.html#problemtype-part">統計モデルの種類</a></li><li><a href="index.html#inputdata-part">データに関する設定</a></li><li><a href="index.html#dataselection-part">どのデータセットを使うか</a></li><li><a href="index.html#ratio-of-training-data-part">トレーニングデータの割合</a></li><li><a href="index.html#noise-part">ノイズ</a></li><li><a href="index.html#batchsize-part">バッチサイズ</a></li><li><a href="index.html#feature-part">入力するデータの特徴と隠し層</a></li><li><a href="index.html#backpropagation-part">バックプロパゲーション(誤差逆伝搬法)</a></li></ul></figure><figure class="collapsible" data-page="[&quot;deeplearning-by-tensorflow&quot;, &quot;how-to-use-tensorboard&quot;, &quot;tensorflow-faq&quot;]"><figcaption><span class="menu-title">TensorFlowでディープラーニング</span><button class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">keyboard_arrow_down</i></button></figcaption><ul><li><a href="deeplearning-by-tensorflow.html">TensorFlowのインストール</a></li><li><a href="deeplearning-by-tensorflow-with-gpu.html">TensorFlowのインストール(GPU利用編)</a></li><li><a href="how-to-use-tensorboard.html">TensorBoardの使い方</a></li><li><a href="tensorflow-faq.html">TensorFlow FAQ</a></li></ul></figure><figure class="collapsible" data-page="[&quot;sample-rock-scissors-paper&quot;]"><figcaption><span class="menu-title">TensorFlow コードサンプル</span><button class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">keyboard_arrow_down</i></button></figcaption><div class="dpln-expand"></div><ul><li><a href="sample-rock-scissors-paper.html">じゃんけんの勝ち方を学習させるデモ</a></li></ul></figure><figure class="collapsible" data-page="math-for-ml"><figcaption><span class="menu-title">機械学習のための数学</span><button class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">keyboard_arrow_down</i></button></figcaption><ul><li><a href="math-for-ml.html">はじめに</a></li><li><a href="math-for-ml.html#random-variable">確率変数</a></li><li><a href="math-for-ml.html#probability-distribution">確率分布</a></li><li><a href="math-for-ml.html#pmf">離散確率分布</a></li><li><a href="math-for-ml.html#pdf">連続確率分布</a></li><li><a href="math-for-ml.html#expectation">期待値</a></li><li><a href="math-for-ml.html#self-information">自己情報量</a></li><li><a href="math-for-ml.html#entropy">エントロピー</a></li><li><a href="math-for-ml.html#kl-divergence">KL情報量</a></li><li><a href="math-for-ml.html#cross-entropy">クロスエントロピー</a></li><li><a href="math-for-ml.html#logits">ロジット</a></li><li><a href="math-for-ml.html#softmax">ソフトマックス関数</a></li><li><a href="math-for-ml.html#sigmoid">シグモイド関数</a></li><li><a href="math-for-ml.html#multiclass-classification">多クラス分類</a></li><li><a href="math-for-ml.html#multilabel-classification">マルチラベル分類</a></li></ul></figure><figure class="collapsible" data-page="[&quot;profile&quot;, &quot;reference&quot;, &quot;useful-tools-and-services&quot;, &quot;private-thoughts&quot;]"><figcaption><span class="menu-title">その他</span><button class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">keyboard_arrow_down</i></button></figcaption><ul><li><a href="profile.html">著者プロフィール</a></li><li><a href="reference.html">参考サイト集</a></li><li><a href="useful-tools-and-services.html">お世話になっているツール/サービス</a></li><li><a href="private-thoughts.html">独り言</a></li></ul></figure></nav><main class="dpln-layout-main"><article class="main-article code-samples" data-page="sample-rock-scissors-paper"><a class="in-page-anchor" id="preface"></a><h1>じゃんけんの勝ち方を学習させるデモ</h1><div class="article-metadata"><div id="post-date"><i class="material-icons md-24">timer</i><span>2017-04-24</span></div><div id="author"><i class="material-icons md-24">person</i><span>Hinase</span></div><span class="author-external-profile"><a class="header-logo-invertocat" href="https://github.com/Hinaser" aria-label="Github Profile"><svg class="octicon octicon-mark-github" aria-hidden="true" height="24" version="1.1" viewbox="0 0 16 16" width="24" fill="rgba(0, 0, 0, 0.7)"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg></a><a class="header-logo-twitter" href="https://twitter.com/h1nase" target="_blank" style="line-height: 30px; display: inline-block; vertical-align: middle; margin-left: 10px; margin-right: 10px;"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 400 400" height="24"><defs><style>.cls-1 {
  fill: #1da1f2;
}

.cls-2 {
  fill: #fff;
}

.cls-3 {
  fill: none;
}</style></defs><title>Twitter_Logo_White-on-Blue</title><g id="Dark_Blue" data-name="Dark Blue"><rect class="cls-1" width="400" height="400"></rect></g><g id="Logo_FIXED" data-name="Logo — FIXED"><path class="cls-2" d="M153.62 301.59c94.34 0 145.94-78.16 145.94-145.94 0-2.22 0-4.43-.15-6.63A104.36 104.36 0 0 0 325 122.47a102.38 102.38 0 0 1-29.46 8.07 51.47 51.47 0 0 0 22.55-28.37 102.79 102.79 0 0 1-32.57 12.45 51.34 51.34 0 0 0-87.41 46.78A145.62 145.62 0 0 1 92.4 107.81a51.33 51.33 0 0 0 15.88 68.47A50.91 50.91 0 0 1 85 169.86c0 .21 0 .43 0 .65a51.31 51.31 0 0 0 41.15 50.28 51.21 51.21 0 0 1-23.16.88 51.35 51.35 0 0 0 47.92 35.62 102.92 102.92 0 0 1-63.7 22A104.41 104.41 0 0 1 75 278.55a145.21 145.21 0 0 0 78.62 23"></path><rect class="cls-3" width="400" height="400"></rect></g></svg></a></span><span class="social-share"><span class="st_facebook_hcount" displaytext="Facebook"></span><span class="st_twitter_hcount" displaytext="Tweet"></span><span class="st_googleplus_hcount" displaytext="Google +"></span></span></div><div class="paragraph"><p>タイトルの通りAIにじゃんけんの勝ち方を学習させるデモを紹介します。</p><p>巷ではAIがプロ棋士に囲碁で勝ったという話題をよく目にします。
このページでは囲碁よりもずっと単純なじゃんけんについて、その勝ち方をAIに学習させる方法について説明します。</p><p>ここでいうAIというのは一体何なのか、AIにゲームの勝ち方を学習させるとはどういうことなのか、実際に何をしているのか。<br/>一つひとつ説明します。</p></div><div class="paragraph"><h4>AIという言葉の意味</h4><p>AIという言葉を聞くとき、私はその言葉がどのような意味で使われているのかわからなくなる時があります。
通常のITシステムによる単なるオートメーション技術のことを、意図的にAIという最もらしいラベルをつけてブランディングしている
のではないかと疑うことが非常に多いです。</p><p>私はAIという言葉の真の意味について時間をかけて調べたことはありませんが、既存のオートメーション技術とAIの違いについては
私ははっきりと違いを認識することができます。</p><p>既存のオートメーション技術は、人が人力でロジックを組み立てます。例えば「ある条件を満たした時、ある値を返す」、
「こういう入力が入ってきたとき、こういう応答を返す」など、あくまでプログラマなどの「人」がどのような処理をすべきか
ルールベースで処理を記述していきます。このような似非AIの特徴は、あくまで設計者が「どのような組み合わせのデータが入力されてくるか」
を事前にある程度想定しており、想定されたデータをif then elseで条件分岐させながら出力するデータを作り上げていくことです。</p><p>それに対し、AIが用いる機械学習的な処理では、人による条件分岐ロジックが存在しません。「あるデータが入力された時、このデータを出力する」
という処理をつくりたいと思った時、それをあらかじめプログラミングしません。
プログラミングするのではなく、こういう入力に対してはこういう出力をする、といった入力と出力の組み合わせのデータを大量に用意し、これを
学習させます。<br/>AIがどのような振る舞いをするかは学習させるデータに依存します。<br/>このページではAIにじゃんけんの勝ち方を学習させることがメインテーマですが、
AI側のロジックを一切変えず学習させるデータを変えることで「AIにじゃんけんの負け方」を学習させることも可能です。</p><p>少し本題からそれてしまいました。あらためて本ページの目標を再確認しましょう。</p></div><div class="paragraph"><h4>目標</h4><p>AIにじゃんけんの勝ち方を学習させる、とだけ書くと何やらとんでもなく複雑でものすごいことをしようとしているように見えますが、
実際にやることは非常に単純です。</p><p>ただ単に、相手がグーを出したらパー、チョキを出したらグー、パーを出したらチョキを出すことをプログラムに学習させるだけです。<br/>通常のじゃんけんは手を同時に出しますが、ここでは後出しじゃんけん、つまり相手が手を出したのを見てこちらも出す手を決めるルールとします。</p><p>さて、これだけであれば機械学習やAIなどを使わなくとも
プログラミング言語を勉強したことのある人なら、すぐに下記のようなコードを思い浮かべるでしょう。<br/>(下記のコードはRubyで書かれていますが、なんとなくやりたいことは解ると思います。)</p><div class="source-code"><!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">winning_hand</span>(opponent_hand)
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&#39;paa&#39;</span> <span style="color: #008800; font-weight: bold">if</span> opponent_hand <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;guu&#39;</span>
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&#39;guu&#39;</span> <span style="color: #008800; font-weight: bold">if</span> opponent_hand <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;choki&#39;</span>
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&#39;choki&#39;</span> <span style="color: #008800; font-weight: bold">if</span> opponent_hand <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;paa&#39;</span>
<span style="color: #008800; font-weight: bold">end</span>
</pre></div></div><p>これは上で例に挙げたいわゆる人力でロジックを組むアプローチです。</p><p>たったこれだけのことをわざわざAIを持ちだして議論することに違和感を覚えるかもしれませんが、もう少し待ってください。<br/>オセロもチェスも囲碁も、乱暴に書くと後出しじゃんけんを複雑にしただけのものです。じゃんけんの勝ち方をAIに学習させることを
理解できれば、その応用の先にオセロやチェス、囲碁の勝ち方をAIに学習させる方法が見えてくるはずです。</p></div><div class="paragraph"><h4>機械学習的アプローチ</h4><p>本題に近づいてきました。プログラムにじゃんけんの勝ち方を学習させる具体的な方法についてです。</p><p>実際のTensorFlowのソースコードを貼る前に、下記にじゃんけんの機械学習モデルの仕様をまとめておきます</p><table><tr><td>入力</td><td>じゃんけんにおいて相手が出す手の確率。例えば[グー: 50%, チョキ: 30%, パー: 20%]</td></tr><tr><td>出力</td><td>相手が出しそうな手に勝てる手。例えば相手がパーを出してくる確率が最も高いなら[グー: 0%, チョキ: 100%, パー: 0%]</td></tr><tr><td>NNタイプ</td><td>MLP(マルチレイヤーパーセプトロン) ※MLPについて詳細は<a href="index.html" target="_blank">こちら</a>を参照。</td></tr><tr><td>レイヤー構成</td><td>3-10-10-3 (入力層、出力層のニューロンが3つずつ、中間の隠し層のニューロンが10個ずつである構成)</td></tr></table><p>上記のレイヤー構成を図示すると下記のようになります。</p><div class="nn-image"><img src="image/code-samples/rock-scissors-paper-nn.png"/></div><p>ニューラルネットワーク自体に「グーが出されたらパーを返す」ようなロジックをハードコーディングすることなく、
単に入出力層、隠し層のネットワーク構成が定義されているだけのプログラムをTensorFlowで作ります。</p></div><div class="paragraph"><h4>Python ソースコード</h4><p>TensorFlowにじゃんけんの勝ち方を学習させるソースコードを以下に置いておきます。<br/>すでにTensorFlowを自分のローカルPCにインストール済みであれば、
下記のコードをコピー＆ペーストして'janken.py'などのようなファイル名で保存し、そのままpythonで実行できます。</p><div class="code">python janken.py</div><div class="source-code"><!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>
os<span style="color: #333333">.</span>environ[<span style="background-color: #fff0f0">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span>] <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;3&#39;</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">tensorflow</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">tf</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">datetime</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">dt</span>

<span style="color: #DD4422">&quot;&quot;&quot;</span>
<span style="color: #DD4422">じゃんけん用学習データを生成するクラス。</span>
<span style="color: #DD4422">本来であればプログラムでデータを自動生成するのではなく、</span>
<span style="color: #DD4422">人が実際にじゃんけんをして得られる”手作り”データを用いる方が</span>
<span style="color: #DD4422">「機械に人間の行動を学習させる」例としては良いのだが</span>
<span style="color: #DD4422">今回は簡単なデモということでデータを自動生成させている。</span>
<span style="color: #DD4422">&quot;&quot;&quot;</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">RockScissorsPaper</span>:
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>, number_of_data<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">1000</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>number_of_data <span style="color: #333333">=</span> number_of_data

    <span style="color: #888888"># 相手が出すじゃんけんの手の確率</span>
    <span style="color: #888888"># 戻値：[グーを出す確率, チョキを出す確率, パーを出す確率]</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">opponent_hand</span>(<span style="color: #007020">self</span>):
        rand_rock <span style="color: #333333">=</span> np<span style="color: #333333">.</span>random<span style="color: #333333">.</span>rand()
        rand_scissors <span style="color: #333333">=</span> np<span style="color: #333333">.</span>random<span style="color: #333333">.</span>rand()
        rand_paper <span style="color: #333333">=</span> np<span style="color: #333333">.</span>random<span style="color: #333333">.</span>rand()
        total <span style="color: #333333">=</span> rand_rock <span style="color: #333333">+</span> rand_scissors <span style="color: #333333">+</span> rand_paper
        <span style="color: #008800; font-weight: bold">return</span> [rand_rock<span style="color: #333333">/</span>total, rand_scissors<span style="color: #333333">/</span>total, rand_paper<span style="color: #333333">/</span>total]

    <span style="color: #888888"># グーが来る確率が一番高かったらパー、</span>
    <span style="color: #888888"># チョキが来る確率が一番高かったらグー、</span>
    <span style="color: #888888"># パーが来る確率が一番高かったらチョキ</span>
    <span style="color: #888888"># を返す。</span>
    <span style="color: #888888"># 引数：[グーが来る確率, チョキが来る確率, パーが来る確率]</span>
    <span style="color: #888888"># 戻値：[グーを返すか否か(0or1), チョキを返すか否か(0or1), パーを返すか否か(0or1)]</span>
    <span style="color: #888888">#</span>
    <span style="color: #888888"># 例:</span>
    <span style="color: #888888"># 引数が[0.6, 0.3, 0.1]の時、グーが来る確率が60%で最も高いため、</span>
    <span style="color: #888888"># グーに勝てるパーを出すため戻値は[0, 0, 1]となる。</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">winning_hand</span>(<span style="color: #007020">self</span>, rock, scissors, paper) <span style="color: #333333">-&gt;</span> [<span style="color: #007020">float</span>, <span style="color: #007020">float</span>, <span style="color: #007020">float</span>]:
        mx <span style="color: #333333">=</span> <span style="color: #007020">max</span>([rock, scissors, paper])
        <span style="color: #008800; font-weight: bold">if</span> rock <span style="color: #333333">==</span> mx: <span style="color: #008800; font-weight: bold">return</span> [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">1</span>]
        <span style="color: #008800; font-weight: bold">if</span> scissors <span style="color: #333333">==</span> mx: <span style="color: #008800; font-weight: bold">return</span> [<span style="color: #0000DD; font-weight: bold">1</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>]
        <span style="color: #008800; font-weight: bold">if</span> paper <span style="color: #333333">==</span> mx: <span style="color: #008800; font-weight: bold">return</span> [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">1</span>, <span style="color: #0000DD; font-weight: bold">0</span>]

    <span style="color: #888888"># この手が来た時にあの手を返すと勝てる、を集めた学習用データ</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">get_supervised_data</span>(<span style="color: #007020">self</span>, n_data<span style="color: #333333">=</span><span style="color: #007020">None</span>):
        <span style="color: #008800; font-weight: bold">if</span> n_data <span style="color: #000000; font-weight: bold">is</span> <span style="color: #007020">None</span>:
            n_data <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>number_of_data

        <span style="color: #888888"># トレーニングデータ生成</span>
        supervised_data_input <span style="color: #333333">=</span> []
        supervised_data_output <span style="color: #333333">=</span> []
        <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(n_data):
            rock_prob, scissors_prob, paper_prob <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>opponent_hand()
            input_probs <span style="color: #333333">=</span> [rock_prob, scissors_prob, paper_prob]
            supervised_data_input<span style="color: #333333">.</span>append(input_probs)
            supervised_data_output<span style="color: #333333">.</span>append(<span style="color: #007020">self</span><span style="color: #333333">.</span>winning_hand(<span style="color: #333333">*</span>input_probs))
        <span style="color: #008800; font-weight: bold">return</span> {<span style="background-color: #fff0f0">&#39;input&#39;</span>: supervised_data_input, <span style="background-color: #fff0f0">&#39;output&#39;</span>: supervised_data_output}


<span style="color: #DD4422">&quot;&quot;&quot;</span>
<span style="color: #DD4422">ここからTensorFlowの機械学習用の処理</span>
<span style="color: #DD4422">処理は下記の流れで実行</span>
<span style="color: #DD4422">(1) 入力層の作成</span>
<span style="color: #DD4422">(2) 隠し層、出力層の作成</span>
<span style="color: #DD4422">(3) 誤差の定義</span>
<span style="color: #DD4422">(4) 学習用TensorFlow Operationの作成</span>
<span style="color: #DD4422">(5) 学習実行</span>
<span style="color: #DD4422">(6) 学習結果検証</span>
<span style="color: #DD4422">&quot;&quot;&quot;</span>
FLAGS <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>app<span style="color: #333333">.</span>flags<span style="color: #333333">.</span>FLAGS
tf<span style="color: #333333">.</span>app<span style="color: #333333">.</span>flags<span style="color: #333333">.</span>DEFINE_string(<span style="background-color: #fff0f0">&#39;summary-dir&#39;</span>, <span style="background-color: #fff0f0">&#39;/tmp/tensorflow/summary&#39;</span>,
                           <span style="background-color: #fff0f0">&quot;TensorBoard用のログを出力するディレクトリのパス&quot;</span>)
tf<span style="color: #333333">.</span>app<span style="color: #333333">.</span>flags<span style="color: #333333">.</span>DEFINE_integer(<span style="background-color: #fff0f0">&#39;max-epoch&#39;</span>, <span style="color: #0000DD; font-weight: bold">100</span>, <span style="background-color: #fff0f0">&quot;最大学習エポック数&quot;</span>)
tf<span style="color: #333333">.</span>app<span style="color: #333333">.</span>flags<span style="color: #333333">.</span>DEFINE_integer(<span style="background-color: #fff0f0">&#39;batch-size&#39;</span>, <span style="color: #0000DD; font-weight: bold">10</span>, <span style="background-color: #fff0f0">&quot;1回のトレーニングステップに用いるデータのバッチサイズ&quot;</span>)
tf<span style="color: #333333">.</span>app<span style="color: #333333">.</span>flags<span style="color: #333333">.</span>DEFINE_float(<span style="background-color: #fff0f0">&#39;learning-rate&#39;</span>, <span style="color: #6600EE; font-weight: bold">0.07</span>, <span style="background-color: #fff0f0">&quot;学習率&quot;</span>)
tf<span style="color: #333333">.</span>app<span style="color: #333333">.</span>flags<span style="color: #333333">.</span>DEFINE_integer(<span style="background-color: #fff0f0">&#39;test-data&#39;</span>, <span style="color: #0000DD; font-weight: bold">10</span>, <span style="background-color: #fff0f0">&quot;テスト用データの数&quot;</span>)
tf<span style="color: #333333">.</span>app<span style="color: #333333">.</span>flags<span style="color: #333333">.</span>DEFINE_integer(<span style="background-color: #fff0f0">&#39;training-data&#39;</span>, <span style="color: #0000DD; font-weight: bold">1000</span>, <span style="background-color: #fff0f0">&quot;学習用データの数&quot;</span>)
tf<span style="color: #333333">.</span>app<span style="color: #333333">.</span>flags<span style="color: #333333">.</span>DEFINE_boolean(<span style="background-color: #fff0f0">&#39;skip-training&#39;</span>, <span style="color: #007020">False</span>, <span style="background-color: #fff0f0">&quot;学習をスキップしてテストだけする場合は指定&quot;</span>)


<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">train_and_test</span>(training_data, test_data):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">len</span>(training_data[<span style="background-color: #fff0f0">&#39;input&#39;</span>]) <span style="color: #333333">!=</span> <span style="color: #007020">len</span>(training_data[<span style="background-color: #fff0f0">&#39;output&#39;</span>]):
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;トレーニングデータの入力と出力のデータの数が一致しません&quot;</span>)
        <span style="color: #008800; font-weight: bold">return</span>
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">len</span>(test_data[<span style="background-color: #fff0f0">&#39;input&#39;</span>]) <span style="color: #333333">!=</span> <span style="color: #007020">len</span>(test_data[<span style="background-color: #fff0f0">&#39;output&#39;</span>]):
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;テストデータの入力と出力のデータの数が一致しません&quot;</span>)
        <span style="color: #008800; font-weight: bold">return</span>

    <span style="color: #888888"># ニューラルネットワークの入力部分の作成</span>
    <span style="color: #008800; font-weight: bold">with</span> tf<span style="color: #333333">.</span>name_scope(<span style="background-color: #fff0f0">&#39;Inputs&#39;</span>):
        <span style="color: #007020">input</span> <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>placeholder(tf<span style="color: #333333">.</span>float32, shape<span style="color: #333333">=</span>[<span style="color: #007020">None</span>, <span style="color: #0000DD; font-weight: bold">3</span>], name<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;Input&#39;</span>)
    <span style="color: #008800; font-weight: bold">with</span> tf<span style="color: #333333">.</span>name_scope(<span style="background-color: #fff0f0">&#39;Outputs&#39;</span>):
        true_output <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>placeholder(tf<span style="color: #333333">.</span>float32, shape<span style="color: #333333">=</span>[<span style="color: #007020">None</span>, <span style="color: #0000DD; font-weight: bold">3</span>], name<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;Output&#39;</span>)

    <span style="color: #888888"># ニューラルネットワークのレイヤーを作成する関数</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">hidden_layer</span>(x, layer_size, is_output<span style="color: #333333">=</span><span style="color: #007020">False</span>):
        name <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;Hidden-Layer&#39;</span> <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> is_output <span style="color: #008800; font-weight: bold">else</span> <span style="background-color: #fff0f0">&#39;Output-Layer&#39;</span>
        <span style="color: #008800; font-weight: bold">with</span> tf<span style="color: #333333">.</span>name_scope(name):
            <span style="color: #888888"># 重み</span>
            w <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>Variable(tf<span style="color: #333333">.</span>random_normal([x<span style="color: #333333">.</span>_shape[<span style="color: #0000DD; font-weight: bold">1</span>]<span style="color: #333333">.</span>value, layer_size]), name<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;Weight&#39;</span>)
            <span style="color: #888888"># バイアス</span>
            b <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>Variable(tf<span style="color: #333333">.</span>zeros([layer_size]), name<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;Bias&#39;</span>)
            <span style="color: #888888"># 入力総和(バッチ単位)</span>
            z <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>matmul(x, w) <span style="color: #333333">+</span> b
            a <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>tanh(z) <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> is_output <span style="color: #008800; font-weight: bold">else</span> z
        <span style="color: #008800; font-weight: bold">return</span> a

    <span style="color: #888888"># レイヤーを作成</span>
    <span style="color: #888888"># 3-10-10-3のDNN</span>
    layer1 <span style="color: #333333">=</span> hidden_layer(<span style="color: #007020">input</span>, <span style="color: #0000DD; font-weight: bold">10</span>)
    layer2 <span style="color: #333333">=</span> hidden_layer(layer1, <span style="color: #0000DD; font-weight: bold">10</span>)
    output <span style="color: #333333">=</span> hidden_layer(layer2, <span style="color: #0000DD; font-weight: bold">3</span>, is_output<span style="color: #333333">=</span><span style="color: #007020">True</span>)

    <span style="color: #888888"># 誤差の定義</span>
    <span style="color: #008800; font-weight: bold">with</span> tf<span style="color: #333333">.</span>name_scope(<span style="background-color: #fff0f0">&quot;Loss&quot;</span>):
        <span style="color: #888888"># クロスエントロピー</span>
        <span style="color: #008800; font-weight: bold">with</span> tf<span style="color: #333333">.</span>name_scope(<span style="background-color: #fff0f0">&quot;Cross-Entropy&quot;</span>):
            error <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>reduce_mean(tf<span style="color: #333333">.</span>nn<span style="color: #333333">.</span>softmax_cross_entropy_with_logits(labels<span style="color: #333333">=</span>true_output, logits<span style="color: #333333">=</span>output))
        <span style="color: #888888"># 真の出力と計算した出力がどれだけ一致するか</span>
        <span style="color: #008800; font-weight: bold">with</span> tf<span style="color: #333333">.</span>name_scope(<span style="background-color: #fff0f0">&quot;Accuracy&quot;</span>):
            accuracy <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>reduce_mean(tf<span style="color: #333333">.</span>cast(tf<span style="color: #333333">.</span>equal(tf<span style="color: #333333">.</span>arg_max(true_output, <span style="color: #0000DD; font-weight: bold">1</span>), tf<span style="color: #333333">.</span>argmax(output, <span style="color: #0000DD; font-weight: bold">1</span>)), tf<span style="color: #333333">.</span>float32)) <span style="color: #333333">*</span> <span style="color: #6600EE; font-weight: bold">100.0</span>
        <span style="color: #008800; font-weight: bold">with</span> tf<span style="color: #333333">.</span>name_scope(<span style="background-color: #fff0f0">&quot;Prediction&quot;</span>):
            <span style="color: #888888"># 出力値を確率にノーマライズするOP(起こりうる事象の和を1にする)</span>
            prediction <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>nn<span style="color: #333333">.</span>softmax(output)

    <span style="color: #888888"># 学習用OPの作成</span>
    <span style="color: #008800; font-weight: bold">with</span> tf<span style="color: #333333">.</span>name_scope(<span style="background-color: #fff0f0">&quot;Train&quot;</span>):
        train_op <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>train<span style="color: #333333">.</span>GradientDescentOptimizer(FLAGS<span style="color: #333333">.</span>learning_rate)<span style="color: #333333">.</span>minimize(error)

    <span style="color: #888888"># セッション生成、変数初期化</span>
    sess <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>Session()
    sess<span style="color: #333333">.</span>run(tf<span style="color: #333333">.</span>global_variables_initializer())

    <span style="color: #888888"># TensorBoard用サマリ</span>
    writer <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>summary<span style="color: #333333">.</span>FileWriter(FLAGS<span style="color: #333333">.</span>summary_dir <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&#39;/&#39;</span> <span style="color: #333333">+</span> dt<span style="color: #333333">.</span>datetime<span style="color: #333333">.</span>now()<span style="color: #333333">.</span>strftime(<span style="background-color: #fff0f0">&#39;%Y%m</span><span style="background-color: #eeeeee">%d</span><span style="background-color: #fff0f0">-%H%M%S&#39;</span>), sess<span style="color: #333333">.</span>graph)
    tf<span style="color: #333333">.</span>summary<span style="color: #333333">.</span>scalar(<span style="background-color: #fff0f0">&#39;CrossEntropy&#39;</span>, error)
    tf<span style="color: #333333">.</span>summary<span style="color: #333333">.</span>scalar(<span style="background-color: #fff0f0">&#39;Accuracy&#39;</span>, accuracy)
    summary <span style="color: #333333">=</span> tf<span style="color: #333333">.</span>summary<span style="color: #333333">.</span>merge_all()

    <span style="color: #888888"># 学習を実行する関数</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">train</span>():
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;----------------------------------------------学習開始----------------------------------------------&#39;</span>)
        batch_size <span style="color: #333333">=</span> FLAGS<span style="color: #333333">.</span>batch_size
        loop_per_epoch <span style="color: #333333">=</span> <span style="color: #007020">int</span>(<span style="color: #007020">len</span>(training_data[<span style="background-color: #fff0f0">&#39;input&#39;</span>]) <span style="color: #333333">/</span> batch_size)
        max_epoch <span style="color: #333333">=</span> FLAGS<span style="color: #333333">.</span>max_epoch
        print_interval <span style="color: #333333">=</span> max_epoch <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">10</span> <span style="color: #008800; font-weight: bold">if</span> max_epoch <span style="color: #333333">&gt;=</span> <span style="color: #0000DD; font-weight: bold">10</span> <span style="color: #008800; font-weight: bold">else</span> <span style="color: #0000DD; font-weight: bold">1</span>
        step <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
        start_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
        <span style="color: #008800; font-weight: bold">for</span> e <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(max_epoch):
            <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(loop_per_epoch):
                batch_input <span style="color: #333333">=</span> training_data[<span style="background-color: #fff0f0">&#39;input&#39;</span>][i<span style="color: #333333">*</span>batch_size:(i<span style="color: #333333">+</span><span style="color: #0000DD; font-weight: bold">1</span>)<span style="color: #333333">*</span>batch_size]
                batch_output <span style="color: #333333">=</span> training_data[<span style="background-color: #fff0f0">&#39;output&#39;</span>][i<span style="color: #333333">*</span>batch_size:(i<span style="color: #333333">+</span><span style="color: #0000DD; font-weight: bold">1</span>)<span style="color: #333333">*</span>batch_size]
                _, loss, acc, report <span style="color: #333333">=</span> sess<span style="color: #333333">.</span>run([train_op, error, accuracy, summary], feed_dict<span style="color: #333333">=</span>{<span style="color: #007020">input</span>: batch_input, true_output: batch_output})
                step <span style="color: #333333">+=</span> batch_size

            writer<span style="color: #333333">.</span>add_summary(report, step)
            writer<span style="color: #333333">.</span>flush()

            <span style="color: #008800; font-weight: bold">if</span> (e<span style="color: #333333">+</span><span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #333333">%</span> print_interval <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>:
                learning_speed <span style="color: #333333">=</span> (e <span style="color: #333333">+</span> <span style="color: #6600EE; font-weight: bold">1.0</span>) <span style="color: #333333">/</span> (time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> start_time)
                <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;エポック:{:3}    クロスエントロピー:{:.6f}    正答率:{:6.2f}%    学習速度:{:5.2f}エポック/秒&#39;</span><span style="color: #333333">.</span>format(e<span style="color: #333333">+</span><span style="color: #0000DD; font-weight: bold">1</span>, loss, acc, learning_speed))

        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;----------------------------------------------学習終了----------------------------------------------&#39;</span>)
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;{}エポックの学習に要した時間: {:.2f}秒&#39;</span><span style="color: #333333">.</span>format(max_epoch, time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> start_time))

    <span style="color: #888888"># 学習成果をテストする関数</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">test</span>():
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;----------------------------------------------検証開始----------------------------------------------&#39;</span>)
        <span style="color: #888888"># ヘッダー</span>
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;{:5}  {:20}      {:20}      {:20}      {:2}&#39;</span><span style="color: #333333">.</span>format(<span style="background-color: #fff0f0">&#39;&#39;</span>, <span style="background-color: #fff0f0">&#39;相手の手&#39;</span>, <span style="background-color: #fff0f0">&#39;勝てる手&#39;</span>, <span style="background-color: #fff0f0">&#39;AIの判断&#39;</span>, <span style="background-color: #fff0f0">&#39;結果&#39;</span>))
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;{}  {:3}   {:3}   {:3}      {:3}   {:3}   {:3}      {:3}   {:3}   {:3}&#39;</span><span style="color: #333333">.</span>format(<span style="background-color: #fff0f0">&#39;No.  &#39;</span>, <span style="background-color: #fff0f0">&#39;グー　&#39;</span>, <span style="background-color: #fff0f0">&#39;チョキ&#39;</span>, <span style="background-color: #fff0f0">&#39;パー　&#39;</span>, <span style="background-color: #fff0f0">&#39;グー　&#39;</span>, <span style="background-color: #fff0f0">&#39;チョキ&#39;</span>, <span style="background-color: #fff0f0">&#39;パー　&#39;</span>, <span style="background-color: #fff0f0">&#39;グー　&#39;</span>, <span style="background-color: #fff0f0">&#39;チョキ&#39;</span>, <span style="background-color: #fff0f0">&#39;パー　&#39;</span>))

        <span style="color: #888888"># 最も確率の高い手を強調表示するための関数</span>
        <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">highlight</span>(rock, scissors, paper):
            mx <span style="color: #333333">=</span> <span style="color: #007020">max</span>(rock, scissors, paper)
            rock_prob_em <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;[{:6.4f}]&#39;</span><span style="color: #333333">.</span>format(rock) <span style="color: #008800; font-weight: bold">if</span> rock <span style="color: #333333">==</span> mx <span style="color: #008800; font-weight: bold">else</span> <span style="background-color: #fff0f0">&#39;{:^8.4f}&#39;</span><span style="color: #333333">.</span>format(rock)
            scissors_prob_em <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;[{:6.4f}]&#39;</span><span style="color: #333333">.</span>format(scissors) <span style="color: #008800; font-weight: bold">if</span> scissors <span style="color: #333333">==</span> mx <span style="color: #008800; font-weight: bold">else</span> <span style="background-color: #fff0f0">&#39;{:^8.4f}&#39;</span><span style="color: #333333">.</span>format(scissors)
            paper_prob_em <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;[{:6.4f}]&#39;</span><span style="color: #333333">.</span>format(paper) <span style="color: #008800; font-weight: bold">if</span> paper <span style="color: #333333">==</span> mx <span style="color: #008800; font-weight: bold">else</span> <span style="background-color: #fff0f0">&#39;{:^8.4f}&#39;</span><span style="color: #333333">.</span>format(paper)
            <span style="color: #008800; font-weight: bold">return</span> [rock_prob_em, scissors_prob_em, paper_prob_em]

        <span style="color: #888888"># N回じゃんけんさせてみてAIが勝てる手を正しく判断できるか検証</span>
        win_count <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
        <span style="color: #008800; font-weight: bold">for</span> k <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #007020">len</span>(test_data[<span style="background-color: #fff0f0">&#39;input&#39;</span>])):
            input_probs <span style="color: #333333">=</span> [test_data[<span style="background-color: #fff0f0">&#39;input&#39;</span>][k]]
            output_probs <span style="color: #333333">=</span> [test_data[<span style="background-color: #fff0f0">&#39;output&#39;</span>][k]]

            <span style="color: #888888"># 検証用オペレーション実行</span>
            acc, predict <span style="color: #333333">=</span> sess<span style="color: #333333">.</span>run([accuracy, prediction], feed_dict<span style="color: #333333">=</span>{<span style="color: #007020">input</span>: input_probs, true_output: output_probs})

            best_bet_label <span style="color: #333333">=</span> np<span style="color: #333333">.</span>argmax(output_probs, <span style="color: #0000DD; font-weight: bold">1</span>)
            best_bet_logit <span style="color: #333333">=</span> np<span style="color: #333333">.</span>argmax(predict, <span style="color: #0000DD; font-weight: bold">1</span>)
            result <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;外れ&#39;</span>
            <span style="color: #008800; font-weight: bold">if</span> best_bet_label <span style="color: #333333">==</span> best_bet_logit:
                win_count <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
                result <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;一致&#39;</span>

            <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;{:&lt;5} {:8} {:8} {:8}&#39;</span><span style="color: #333333">.</span>format(<span style="color: #333333">*</span>(<span style="color: #007020">tuple</span>([k<span style="color: #333333">+</span><span style="color: #0000DD; font-weight: bold">1</span>]<span style="color: #333333">+</span>highlight(<span style="color: #333333">*</span>input_probs[<span style="color: #0000DD; font-weight: bold">0</span>])))), end<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;&#39;</span>)
            <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;    &#39;</span>, end<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;&#39;</span>)
            <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;{:8} {:8} {:8}&#39;</span><span style="color: #333333">.</span>format(<span style="color: #333333">*</span><span style="color: #007020">tuple</span>(highlight(<span style="color: #333333">*</span>output_probs[<span style="color: #0000DD; font-weight: bold">0</span>]))), end<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;&#39;</span>)
            <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;    &#39;</span>, end<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;&#39;</span>)
            <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;{:8} {:8} {:8}&#39;</span><span style="color: #333333">.</span>format(<span style="color: #333333">*</span><span style="color: #007020">tuple</span>(highlight(<span style="color: #333333">*</span>predict[<span style="color: #0000DD; font-weight: bold">0</span>]))), end<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;&#39;</span>)
            <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;    &#39;</span>, end<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;&#39;</span>)
            <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;{:2}&#39;</span><span style="color: #333333">.</span>format(result))

        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;----------------------------------------------検証終了----------------------------------------------&#39;</span>)
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;AIの勝率: {}勝/{}敗 勝率{:4.3f}%&#39;</span><span style="color: #333333">.</span>format(win_count, FLAGS<span style="color: #333333">.</span>test_data<span style="color: #333333">-</span>win_count, (win_count<span style="color: #333333">/</span><span style="color: #007020">len</span>(test_data[<span style="background-color: #fff0f0">&#39;input&#39;</span>]) <span style="color: #333333">*</span> <span style="color: #6600EE; font-weight: bold">100.0</span>)))

    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;学習無しの素の状態でAIがじゃんけんに勝てるか確認&#39;</span>)
    test()

    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> FLAGS<span style="color: #333333">.</span>skip_training:
        train()
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;学習後、AIのじゃんけんの勝率はいかに…！&#39;</span>)
        test()


<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">main</span>(argv<span style="color: #333333">=</span><span style="color: #007020">None</span>):
    <span style="color: #888888"># 学習用データ取得</span>
    janken <span style="color: #333333">=</span> RockScissorsPaper()
    training_data <span style="color: #333333">=</span> janken<span style="color: #333333">.</span>get_supervised_data(FLAGS<span style="color: #333333">.</span>training_data)
    test_data <span style="color: #333333">=</span> janken<span style="color: #333333">.</span>get_supervised_data(FLAGS<span style="color: #333333">.</span>test_data)

    train_and_test(training_data, test_data)

<span style="color: #008800; font-weight: bold">if</span> __name__ <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;__main__&#39;</span>:
    tf<span style="color: #333333">.</span>app<span style="color: #333333">.</span>run()
</pre></div>
</div><p>上記のソースコードを自分の環境で実行するためにはマシンにTensorFlowをインストールが必要があります。<br/>TensorFlowのインストール方法については本サイトでも他のページで解説していますが、CPUやGPUの最適化を考えずとりあえずデモが動けば良い程度で
あればpython3をマシンにインストールし管理者権限で`pip3 install --upgrade tensorflow`とコマンドを打てばWindowsでもLinuxでもTensorFlowを導入できます。</p></div><div class="paragraph"><h4>コード実行結果例</h4><p>上記のコードを引数無しでそのまま実行すると、下記の処理が走ります。</p><ol><li>相手のじゃんけんの手、およびその手に勝てる手の組み合わせのデータを1000セット生成</li><li>層構成が3-10-10-3のニューラルネットワーク(MLP)の計算グラフを作成</li><li>学習前の赤ん坊状態のAIにじゃんけんをさせてみて勝率を確認(当てずっぽうに手を出すので勝率は33%程度となる見込み。)</li><li>100エポック分上記の学習用データを使って機械学習開始。(1エポックの定義については<a href="index.html#batchsize-part" target="_blank">こちら</a>を参照)。</li><li>学習後、じゃんけんをさせAIの勝率を再度確認</li></ol><p>それでは試しにこのソースコードを実行して出力を確認してみましょう。</p><pre class="console-output">(tensorflow) someuser@somehost:~/tensorflow-test$ python janken.py
学習無しの素の状態でAIがじゃんけんに勝てるか確認
----------------------------------------------検証開始----------------------------------------------
       相手の手                      勝てる手                      AIの判断                     結果
No.    グー　   チョキ   パー　      グー　   チョキ   パー　      グー　   チョキ   パー　
1      0.1259  [0.8430]  0.0311     [1.0000]  0.0000   0.0000      0.0114  [0.9873]  0.0013     外れ
2     [0.4561]  0.1684   0.3755      0.0000   0.0000  [1.0000]     0.0191  [0.9346]  0.0462     外れ
3     [0.4827]  0.3280   0.1893      0.0000   0.0000  [1.0000]     0.0641  [0.9019]  0.0340     外れ
4     [0.7317]  0.1438   0.1245      0.0000   0.0000  [1.0000]    [0.5712]  0.0517   0.3770     外れ
5      0.3394  [0.4240]  0.2366     [1.0000]  0.0000   0.0000      0.0084  [0.9875]  0.0041     外れ
6      0.3231   0.2909  [0.3860]     0.0000  [1.0000]  0.0000      0.0046  [0.9873]  0.0081     一致
7     [0.4529]  0.3157   0.2314      0.0000   0.0000  [1.0000]     0.0294  [0.9473]  0.0232     外れ
8     [0.6105]  0.1652   0.2243      0.0000   0.0000  [1.0000]     0.2446  [0.5118]  0.2436     外れ
9     [0.6131]  0.3463   0.0406      0.0000   0.0000  [1.0000]    [0.5171]  0.3063   0.1766     外れ
10     0.4289  [0.5422]  0.0289     [1.0000]  0.0000   0.0000      0.1689  [0.8165]  0.0146     外れ
----------------------------------------------検証終了----------------------------------------------
AIの勝率: 1勝/9敗 勝率10.000%
----------------------------------------------学習開始----------------------------------------------
エポック: 10    クロスエントロピー:0.176981    正答率: 90.00%    学習速度:26.99エポック/秒
エポック: 20    クロスエントロピー:0.158905    正答率: 90.00%    学習速度:27.19エポック/秒
エポック: 30    クロスエントロピー:0.140431    正答率: 90.00%    学習速度:27.17エポック/秒
エポック: 40    クロスエントロピー:0.120159    正答率: 90.00%    学習速度:27.26エポック/秒
エポック: 50    クロスエントロピー:0.099404    正答率:100.00%    学習速度:27.30エポック/秒
エポック: 60    クロスエントロピー:0.076915    正答率:100.00%    学習速度:27.32エポック/秒
エポック: 70    クロスエントロピー:0.057713    正答率:100.00%    学習速度:27.31エポック/秒
エポック: 80    クロスエントロピー:0.048996    正答率:100.00%    学習速度:27.28エポック/秒
エポック: 90    クロスエントロピー:0.045507    正答率:100.00%    学習速度:27.26エポック/秒
エポック:100    クロスエントロピー:0.042403    正答率:100.00%    学習速度:27.27エポック/秒
----------------------------------------------学習終了----------------------------------------------
100エポックの学習に要した時間: 3.67秒
学習後、AIのじゃんけんの勝率はいかに…！
----------------------------------------------検証開始----------------------------------------------
       相手の手                      勝てる手                      AIの判断                     結果
No.    グー　   チョキ   パー　      グー　   チョキ   パー　      グー　   チョキ   パー　
1      0.1259  [0.8430]  0.0311     [1.0000]  0.0000   0.0000     [1.0000]  0.0000   0.0000     一致
2     [0.4561]  0.1684   0.3755      0.0000   0.0000  [1.0000]     0.0000   0.0001  [0.9999]    一致
3     [0.4827]  0.3280   0.1893      0.0000   0.0000  [1.0000]     0.0000   0.0000  [1.0000]    一致
4     [0.7317]  0.1438   0.1245      0.0000   0.0000  [1.0000]     0.0000   0.0000  [1.0000]    一致
5      0.3394  [0.4240]  0.2366     [1.0000]  0.0000   0.0000     [0.9999]  0.0000   0.0001     一致
6      0.3231   0.2909  [0.3860]     0.0000  [1.0000]  0.0000      0.0000  [0.9999]  0.0001     一致
7     [0.4529]  0.3157   0.2314      0.0000   0.0000  [1.0000]     0.0000   0.0000  [1.0000]    一致
8     [0.6105]  0.1652   0.2243      0.0000   0.0000  [1.0000]     0.0000   0.0000  [1.0000]    一致
9     [0.6131]  0.3463   0.0406      0.0000   0.0000  [1.0000]     0.0001   0.0000  [0.9999]    一致
10     0.4289  [0.5422]  0.0289     [1.0000]  0.0000   0.0000     [0.9939]  0.0000   0.0061     一致
----------------------------------------------検証終了----------------------------------------------
AIの勝率: 10勝/0敗 勝率100.000%
</pre><p>学習前は後出しじゃんけんでAIはどの手を出すべきか全くわかっていませんので当てずっぽうに手を出し、勝率は10%になっています。<br/>そして学習後、たった10回の試行ではありますが、AIはどの手を出せば勝てるかきちんと学習していることがわかります。</p><h4>テスト回数を増やしてみる</h4><p>上記のpythonプログラムは引数でニューラルネットワークのパラメータをいくつか変えることができます。
例えば</p><div class="code">python janken.py --test-data 100</div><p>のように--test-dataのオプションを使うと、この例ではAIのじゃんけんの勝率を100個のテストデータで検証することができます。<br/>私の環境ではテストデータ100個のテストデータのテストを数回してみましたが、ほとんどのケースでAIが100勝0敗で勝率100%を達成していました。<br/>まれに98勝2敗のようにAIが後出しじゃんけんに負けるケースも確認できました。<br/>そういったケースでは下記のように、相手が出す手の確率が横並びになっており相手がどの手を出すかはっきりと断定しにくい状態が多く見られました。
相手が確実にグーを出してくるならパーを出せば良いと判断できますが、グーとパーを出す確率がほぼ同じであれば出す手に悩みますね。
こういったところは非常に人間的な判断に見えてしまいます。</p><pre class="console-output">----------------------------------------------検証開始----------------------------------------------
       相手の手                      勝てる手                      AIの判断                     結果
No.    グー　   チョキ   パー　      グー　   チョキ   パー　      グー　   チョキ   パー　
...
29    [0.4471]  0.1112   0.4417      0.0000   0.0000  [1.0000]     0.0003  [0.5777]  0.4220     外れ
...
55    [0.4861]  0.4796   0.0343      0.0000   0.0000  [1.0000]    [0.5512]  0.0003   0.4486     外れ
</pre><h4>AIに「じゃんけんの負け方を教える」</h4><p>本ページ冒頭でデータを変えることでじゃんけんの負け方を学習させることが可能と書きました。
さて、それでは上記のソースコードをどう変えればAIにじゃんけんの負け方を教えることができるでしょうか。</p><p>答えは非常に単純です。学習用データを自動生成するクラスRockScissorsPaperの下記のメソッドをこっそり変えてやれば良いのです。</p><div class="source-code"><!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    <span style="color: #888888"># グーが来る確率が一番高かったらパー、</span>
    <span style="color: #888888"># チョキが来る確率が一番高かったらグー、</span>
    <span style="color: #888888"># パーが来る確率が一番高かったらチョキ</span>
    <span style="color: #888888"># を返す。</span>
    <span style="color: #888888"># 引数：[グーが来る確率, チョキが来る確率, パーが来る確率]</span>
    <span style="color: #888888"># 戻値：[グーを返すか否か(0or1), チョキを返すか否か(0or1), パーを返すか否か(0or1)]</span>
    <span style="color: #888888">#</span>
    <span style="color: #888888"># 例:</span>
    <span style="color: #888888"># 引数が[0.6, 0.3, 0.1]の時、グーが来る確率が60%で最も高いため、</span>
    <span style="color: #888888"># グーに勝てるパーを出すため戻値は[0, 0, 1]となる。</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">winning_hand</span>(<span style="color: #007020">self</span>, rock, scissors, paper) <span style="color: #333333">-&gt;</span> [<span style="color: #007020">float</span>, <span style="color: #007020">float</span>, <span style="color: #007020">float</span>]:
        mx <span style="color: #333333">=</span> <span style="color: #007020">max</span>([rock, scissors, paper])
        <span style="color: #008800; font-weight: bold">if</span> rock <span style="color: #333333">==</span> mx: <span style="color: #008800; font-weight: bold">return</span> [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">1</span>]
        <span style="color: #008800; font-weight: bold">if</span> scissors <span style="color: #333333">==</span> mx: <span style="color: #008800; font-weight: bold">return</span> [<span style="color: #0000DD; font-weight: bold">1</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>]
        <span style="color: #008800; font-weight: bold">if</span> paper <span style="color: #333333">==</span> mx: <span style="color: #008800; font-weight: bold">return</span> [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">1</span>, <span style="color: #0000DD; font-weight: bold">0</span>]
</pre></div>
</div><p>このメソッドは相手が最も出しそうな手に勝てる手のデータを返します。<br/>ここで、相手が最も出しそうな手に負ける手を返すようにメソッドを修正すれば
「相手が出した手に負ける手」の学習用データが大量生成され、AIは負けることをひたすら学習します。</p><p>このように、AI自身は自分が何を学習しているか全くわかっていません。
勝ち方を学習しているのか、負け方を学習しているのか、そもそもじゃんけんがテーマかすら認識していません。
あくまでデータの内容に意味付けをするのは我々人間です。AIは機械学習の数学に則って
真の出力と計算した出力との誤差が小さくなるようニューラルネットワークのパラメータの更新を繰り返すだけです。</p><p>学習させるデータによってAIは善にも悪にもなりうる、そういったSFのような壮大な話が、
この単純なじゃんけんの学習を通じてその一端を理解できるというのは非常に感慨深いですね。</p><h4>おまけ: Tensorboardの計算グラフ</h4><p>ソースコードの中にTensorboard関連の処理を入れておきましたが、
このコードを実行して得られる計算グラフを参考までに紹介します。</p><div class="nn-image"><img src="image/code-samples/rock-scissors-paper-tensorboard-graph.png" alt="Tensorboard graph image"/></div><p>私は記事を書いている時点ではMLPのような単純なニューラルネットの計算グラフしかまだ扱っていませんが、
これがCNN(畳み込みニューラルネット)やLSTMなどのRNN(再帰型ニューラルネット)ではどのようなグラフになっていくのか気になって仕方ありません。</p></div><div id="disqus_thread"></div><script>var disqus_config = function () {
    this.page.url = document.location.href;
    this.page.identifier = document.location.pathname;
};
(function () { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://hinaser-github-io-machine-learning.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script></article></main></div><script src="js/main.js?8fc1038fbd" data-turbolinks-track="reload"></script><script src="js/raw/analytics.js" data-turbolinks-track="reload"></script></body></html>